---
title: "Tutorial for the `its2es' R package"
subtitle: "Based on the paper Effect Size Quantification for Interrupted Time Series Analysis: Implementation in R for Covid-19 Research"
output: pdf_document
---

# Load library and data
We start by loading the `its2es' package and examining the Israeli unemployment data. This is the same data-set analyzed in the paper.
```{r message=FALSE}
library(its2es)
data <- unemployed
summary(data)
```

# 1. Fit an ITS linear regression model to continuous outcomes
First we show how to fit an ITS linear regression model to the continuous outcome unemployment percent. 

## Define formula and intervention start index for the Covid-19 period
We need to define both a formula object, and the intervention start index. The minimal formula must include the response on the left hand side of the ~ operator, and the time covariate on the right. Any additional covariates can also be passed to the right hand side of the formula, separated by + operators. 
```{r}
form <- as.formula("percent ~ time")
intervention_start_ind <- which(data$year==2020 & data$month>2| data$year==2021)[1]
```

## Fit an ITS linear regression model to continuous outcomes
Next we need to call the its_lm() function to fit the ITS regression model and to quantify the effect size. Here we use a frequency of 12, corresponding to monthly data, no seasonal adjustments, and a full impact model including both a level change and a slope change following the intervention. Additionally, we set the counterfactual argument to TRUE as we are interested in plotting both the fitted values, and the model-based counterfactual values.
```{r}
fit <- its_lm(data=data,form=form,time_name = "time",intervention_start_ind=intervention_start_ind,
              freq=12,seasonality= "none", impact_model = "full",counterfactual = TRUE)
```

## Plot predicted values (fitted values and counterfactual values)
We use the function plot_its_lm() to plot the predicted values (fitted values and counterfactual values), together with a scatter plot of the original outcome. For the first argument, we use the updated data that includes both the fitted values and the model-based counterfactual values. We also must supply the intervention start index, the ylabel for the figure, the column name of the continuous outcome, and the column name of the date column.
```{r}
p <- plot_its_lm(data=fit$data,intervention_start_ind=intervention_start_ind,
                 y_lab="Unemployment percent", response="percent", date_name= "dt")
p
```

# 2. Fit an ITS linear regression model with seasonal adjustments to continuous outcomes
Second we show how to fit an ITS linear regression model with seasonal adjustments. We use the same formula and intervention start index as before. The only difference is that this time we call the its_lm() function with seasonality= "full".

```{r}
fit <- its_lm(data=data,form=form,time_name = "time",intervention_start_ind=intervention_start_ind,
              freq=12,seasonality= "full", impact_model = "full",counterfactual = TRUE)
```

## Plot predicted values (fitted values and counterfactual values)
```{r}
p <- plot_its_lm(data=fit$data,intervention_start_ind=intervention_start_ind,
                 y_lab="Unemployment percent", response="percent", date_name= "dt")
p
```

# 3. Fit an ITS Poisson regression model to count outcomes
Third we show how to fit an ITS Poisson regression model to the number of unemployed. 

## Define formula 
We need to define a new formula object, with the count outcome on the left hand side of the ~ operator, and the time covariate on the right. As before, any additional covariates can also be passed to the right hand side of the formula, separated by + operators. 
```{r}
form <- as.formula("unemployed ~ time")
```

## Fit an ITS Poisson regression model to count outcomes
Next we need to call the its_poisson() function to fit the ITS regression model and to quantify the effect size. We add the total labour force as our offset term (as we are interested in the unemployment rate), and we set the overdispersion argument to TRUE (as the data is over-dispersed) and hence a quasi-Poisson regression model will be used. As before, we use a frequency of 12, corresponding to monthly data, no seasonal adjustments, and a full impact model including both a level change and a slope change following the intervention. Additionally, we set the counterfactual argument to TRUE as we are interested in plotting both the fitted values, and the model-based counterfactual values. 

```{r}
fit <- its_poisson(data=data,form=form,offset_name = "labour", time_name = "time",
                   intervention_start_ind=intervention_start_ind, over_dispersion=TRUE,
                   freq=12,seasonality= "none", impact_model = "full",counterfactual = TRUE)
```

## Plot predicted values (fitted values and counterfactual values)
We use the function plot_its_poisson() to plot the predicted values (fitted values and counterfactual values), together with a scatter plot of the outcome. For the first argument, we use the updated data that includes both the fitted values and the model-based counterfactual values. We also must supply the intervention start index, the ylabel for the figure, the column name of the count outcome, and the column name of the date column. Note that the additional argument offset_name, which is specific to Poisson regression, can either be set to NULL, in which case the predictions and the original outcomes are plotted on their original count scale, or set to the column name of the offset term (if exists), in which case the predictions and the outcome will be divided by the offset and multiplied by 100.
```{r}
p <- plot_its_poisson(data=fit$data,intervention_start_ind=intervention_start_ind,
                      y_lab="unemployment percent",response="unemployed", offset_name = "labour",
                      date_name= "dt")
p
p2 <- plot_its_poisson(data=fit$data,intervention_start_ind=intervention_start_ind,
                       y_lab="unemployment count",response="unemployed", offset_name = NULL,
                       date_name="dt")
p2
```


# 4. Fit an ITS Poisson regression model with seasonal adjustments to count outcomes
Fourth we show how to fit an ITS Poisson regression model with seasonal adjustments. We use the same formula and intervention start index as in 3. The only difference is that this time we call the its_poisson() function with seasonality= "full".

```{r}
fit <- its_poisson(data=data,form=form,offset_name = "labour", time_name = "time",
                   intervention_start_ind=intervention_start_ind, over_dispersion=TRUE,
                   freq=12,seasonality= "full", impact_model = "full",counterfactual = TRUE)
```

## Plot predicted values (fitted values and counterfactual values)
```{r}
p <- plot_its_poisson(data=fit$data,intervention_start_ind=intervention_start_ind,
                      y_lab="unemployment percent",response="unemployed", offset_name = "labour",
                      date_name= "dt")
p
p2 <- plot_its_poisson(data=fit$data,intervention_start_ind=intervention_start_ind,
                       y_lab="unemployment count",response="unemployed", offset_name = NULL,
                       date_name="dt")
p2
```
